<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF.js Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        #pdf-canvas {
            border: 1px solid black;
            width: 100%;
            max-width: 100%;
            height: auto;
        }
        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #debug-section {
            display: none;
            margin-top: 20px;
        }
        #debug-link {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>PDF.js Example</h1>
    <p id="version-display"></p>
    <p id="debug-link">Show Debug Information</p>
    <div id="controls">
        <input type="file" id="file-input" accept="application/pdf"/>
        <button id="download-csv">Download CSV</button>
    </div>
    <canvas id="pdf-canvas"></canvas>
    <div id="debug-section">
        <h2>Top 10 X Coordinates (Rounded)</h2>
        <table id="coordinates-table" border="1">
            <thead>
                <tr>
                    <th>X Coordinate</th>
                    <th>Occurrences</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h2>Raw CSV Output</h2>
        <pre id="raw-csv-output"></pre>
    </div>
    <script>
        var version = "34";
        document.getElementById('version-display').textContent = "Version: " + version;

        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }

            var fileReader = new FileReader();
            fileReader.onload = function() {
                var typedarray = new Uint8Array(this.result);

                // Load PDF
                pdfjsLib.getDocument({data: typedarray}).promise.then(function(pdf) {
                    var numPages = pdf.numPages;
                    var finalText = [];
                    var transactionId = 1;
                    var prevX = 0;
                    var prevY = 0;
                    var wordNumber = 1;

                    // Function to get text from each page
                    function getPageText(pageNum) {
                        return pdf.getPage(pageNum).then(function(page) {
                            var scale = 1.0;
                            var viewport = page.getViewport({ scale: scale });

                            // Prepare canvas using PDF page dimensions
                            var canvas = document.getElementById('pdf-canvas');
                            var context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            // Check if the canvas height exceeds the window height
                            if (canvas.height > window.innerHeight) {
                                scale = window.innerHeight / canvas.height;
                                viewport = page.getViewport({ scale: scale });
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                            }

                            // Render PDF page into canvas context
                            var renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            page.render(renderContext);

                            // Extract text from the page
                            return page.getTextContent().then(function(textContent) {
                                var textItems = textContent.items;
                                var pageTexts = textItems.map((item, index) => {
                                    var x = item.transform[4];
                                    var y = item.transform[5];
                                    var roundedX = Math.floor(x / 20) * 20;
                                    var roundedY = Math.floor(y / 20) * 20;

                                    // Determine if it's a new transaction
                                    if ((x < prevX && y < prevY) || index === 0) {
                                        transactionId++;
                                    }

                                    prevX = x;
                                    prevY = y;

                                    // Skip empty words
                                    if (item.str.trim() === "") {
                                        return null;
                                    }

                                    return {
                                        str: item.str,
                                        x: x,
                                        y: y,
                                        page: pageNum, // Add page number
                                        roundedX: roundedX, // Rounded X coordinate
                                        roundedY: roundedY, // Rounded Y coordinate
                                        transactionId: transactionId,
                                        wordNumber: wordNumber++
                                    };
                                }).filter(item => item !== null); // Filter out null values
                                finalText.push(...pageTexts);
                                return pageTexts;
                            });
                        });
                    }

                    // Loop through all pages and extract text
                    var promises = [];
                    for (var i = 1; i <= numPages; i++) {
                        promises.push(getPageText(i));
                    }

                    Promise.all(promises).then(function() {
                        // Convert the final text to CSV format
                        var csvContent = convertToCSV(finalText);
                        document.getElementById('download-csv').onclick = function() {
                            downloadCSV(csvContent);
                        };

                        // Display debug information
                        displayDebugInformation(finalText, csvContent);
                    });
                });
            };

            fileReader.readAsArrayBuffer(file);
        });

        document.getElementById('debug-link').addEventListener('click', function() {
            var debugSection = document.getElementById('debug-section');
            if (debugSection.style.display === 'none') {
                debugSection.style.display = 'block';
                window.scrollTo(0, document.body.scrollHeight);
            } else {
                debugSection.style.display = 'none';
            }
        });

        function convertToCSV(textItems) {
            var csv = "Page,WordNumber,X,Y,Text,RoundedX,RoundedY,TransactionID\n"; // Add headers
            textItems.forEach(item => {
                csv += `${item.page},${item.wordNumber},${item.x},${item.y},"${item.str}",${item.roundedX},${item.roundedY},${item.transactionId}\n`;
            });
            return csv;
        }

        function downloadCSV(csvContent) {
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            var url = URL.createObjectURL(blob);
            var now = new Date();
            var isoDate = now.toISOString();
            var filename = `output_v${version}_${isoDate}.csv`;
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function displayDebugInformation(textItems, csvContent) {
            // Calculate top 10 rounded X coordinates
            var xCounts = {};
            textItems.forEach(item => {
                if (!xCounts[item.roundedX]) {
                    xCounts[item.roundedX] = 0;
                }
                xCounts[item.roundedX]++;
            });

            var sortedX = Object.keys(xCounts).sort((a, b) => xCounts[b] - xCounts[a]).slice(0, 10);
            var coordinatesTable = document.getElementById('coordinates-table').getElementsByTagName('tbody')[0];
            coordinatesTable.innerHTML = '';
            sortedX.forEach(x => {
                var row = coordinatesTable.insertRow();
                var cellX = row.insertCell(0);
                var cellCount = row.insertCell(1);
                cellX.textContent = x;
                cellCount.textContent = xCounts[x];
            });

            // Display raw CSV output with transaction subheadings
            var rawOutput = "";
            var currentTransaction = -1;
            var uniqueRoundedXCoords = [];
            textItems.forEach(item => {
                if (item.transactionId !== currentTransaction) {
                    currentTransaction = item.transactionId;
                    rawOutput += `\nTransaction ${currentTransaction}:\n`;
                    uniqueRoundedXCoords = [];
                }

                if (!uniqueRoundedXCoords.includes(item.roundedX)) {
                    uniqueRoundedXCoords.push(item.roundedX);
                }

                rawOutput += `${item.page},${item.wordNumber},${item.x},${item.y},"${item.str}",${item.roundedX},${item.roundedY},${item.transactionId}\n`;
            });

            rawOutput += `\nUnique Rounded X Coordinates per Transaction:\n`;
            textItems.forEach(item => {
                if (item.transactionId !== currentTransaction) {
                    currentTransaction = item.transactionId;
                    rawOutput += `Transaction ${currentTransaction}: ${uniqueRoundedXCoords.join(", ")}\n`;
                }
            });

            document.getElementById('raw-csv-output').textContent = rawOutput;
        }
    </script>
</body>
</html>
