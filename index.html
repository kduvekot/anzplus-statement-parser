<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF.js Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        #pdf-canvas {
            border: 1px solid black;
            width: 100%;
            max-width: 100%;
            height: auto;
        }
        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>PDF.js Example</h1>
    <p>Version: Commit df19e1b on 2025-01-04 14:43:52 UTC</p>
    <div id="controls">
        <input type="file" id="file-input" accept="application/pdf"/>
        <button id="download-csv">Download CSV</button>
    </div>
    <canvas id="pdf-canvas"></canvas>
    <script>
        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }

            var fileReader = new FileReader();
            fileReader.onload = function() {
                var typedarray = new Uint8Array(this.result);

                // Load PDF
                pdfjsLib.getDocument({data: typedarray}).promise.then(function(pdf) {
                    var numPages = pdf.numPages;
                    var finalText = [];

                    // Function to get text from each page
                    function getPageText(pageNum) {
                        return pdf.getPage(pageNum).then(function(page) {
                            var scale = 1.0;
                            var viewport = page.getViewport({ scale: scale });

                            // Prepare canvas using PDF page dimensions
                            var canvas = document.getElementById('pdf-canvas');
                            var context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            // Check if the canvas height exceeds the window height
                            if (canvas.height > window.innerHeight) {
                                scale = window.innerHeight / canvas.height;
                                viewport = page.getViewport({ scale: scale });
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                            }

                            // Render PDF page into canvas context
                            var renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            page.render(renderContext);

                            // Extract text from the page
                            return page.getTextContent().then(function(textContent) {
                                var textItems = textContent.items;
                                var pageTexts = textItems.map(item => ({
                                    str: item.str,
                                    x: item.transform[4],
                                    y: item.transform[5],
                                    page: pageNum // Add page number
                                }));
                                finalText.push(...pageTexts);
                                return pageTexts;
                            });
                        });
                    }

                    // Loop through all pages and extract text
                    var promises = [];
                    for (var i = 1; i <= numPages; i++) {
                        promises.push(getPageText(i));
                    }

                    Promise.all(promises).then(function() {
                        // Determine the most used X coordinates
                        var xCounts = {};
                        finalText.forEach(item => {
                            if (!xCounts[item.x]) {
                                xCounts[item.x] = 0;
                            }
                            xCounts[item.x]++;
                        });

                        var sortedX = Object.keys(xCounts).sort((a, b) => xCounts[b] - xCounts[a]);
                        var mainColumns = sortedX.slice(0, 5); // Adjust the number of columns as needed

                        // Group items by column
                        var groupedItems = finalText.filter(item => mainColumns.includes(item.x.toString()));

                        // Convert the grouped items to CSV format
                        var csvContent = convertToCSV(groupedItems);
                        document.getElementById('download-csv').onclick = function() {
                            downloadCSV(csvContent);
                        };
                    });
                });
            };

            fileReader.readAsArrayBuffer(file);
        });

        function convertToCSV(items) {
            var csv = "Page,X,Y,Text\n"; // Add headers
            items.forEach(item => {
                csv += `${item.page},${item.x},${item.y},"${item.str}"\n`;
            });
            return csv;
        }

        function downloadCSV(csvContent) {
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "output.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
